{
  "handler": "Microsoft.Compute.MultiVm",
  "version": "0.1.2",
  "parameters": {
    "basics": [
    ],
    "steps": [
      {
        "label": "Informatica Enterprise Information Catalog Settings",
        "name": "infaDomainConfiguration",
        "subLabel": {
          "preValidation": "Configure Settings",
          "postValidation": "Done"
        },


        "bladeTitle": "Informatica Enterprise Information Catalog Settings",
        "elements": [

          {
            "name": "infaDomainUser",
            "type": "Microsoft.Common.TextBox",
            "label": "Informatica Administrator Username",
            "defaultValue": "Administrator",
            "toolTip": "Specify the Informatica Administrator username.",
            "constraints": {
              "required": true,
              "regex": "^[a-z0-9A-Z_]{3,30}$",
              "validationMessage": "Only alphanumeric characters and underscore are allowed. The value must be 3-30 character long."
            }
          },
          {
            "name": "infaDomainPassword",
            "type": "Microsoft.Common.PasswordBox",
            "toolTip": "Specify the password for the Informatica Administrator username.",
            "label": {
              "password": "Informatica Administrator Password"
            },
            "constraints": {
              "required": true,
              "regex": "^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d)(?=.*[^\\s\\w])(?!.*[\"$]).{8,123}$",
              "validationMessage": "Password must be at least 8 characters in length. Should contain at least one special character, number, upper-case and lower-case character. Double quote(\") and dollar($) are not allowed."
            },
            "options": {
              "hideConfirmation": true
            }
          },

          {
            "name": "infaDomainLicense",
            "type": "Microsoft.Common.FileUpload",
            "label": "Informatica Enterpise Information Catalog License Key",
            "toolTip": "Provide a valid Informatica Enterpise Information Catalog License key file.",
            "constraints": {
              "required": true,
              "accept": ".key"
            },
            "options": {
              "multiple": false,
              "uploadMode": "url",
              "openMode": "text",
              "encoding": "UTF-8"
            },
            "visible": true
          },


          {
            "name": "informaticaServerInstanceSize",
            "type": "Microsoft.Compute.SizeSelector",
            "label": "Informatica Domain Instance Type",
            "defaultValue": "Standard_D5_v2",
            "toolTip": "The size of Informatica domain instance.",
            "recommendedSizes": [
              "Standard_D3_v2",
              "Standard_D4_v2",
              "Standard_D5_v2"
            ],
            "constraints": {
              "excludedSizes": [
                "Standard_D2s_v3",
                "Standard_E2s_v3",
                "Standard_D2s_v2",
                "Standard_DS11_v2",
                "Standard_D11_v2",
                "Standard_DS11_v2_Promo",
                "Standard_D11_v2_Promo",
                "Standard_DS2_v2_Promo",
                "Standard_D2_v2_Promo",
                "Standard_B1s",
                "Standard_B1ms",
                "Standard_B2ms",
                "Standard_A2m_v2",
                "Standard_A5",
                "Standard_B2s",
                "Standard_DS11",
                "Standard_D11",
                "Standard_GS1",
                "Standard_G1",
                "Standard_D2_v3",
                "Standard_E2_v3",
                "Standard_D2_v2",
                "Standard_DS2",
                "Standard_D2",
                "Standard_DS2_v2",
                "Standard_DS1_v2",
                "Standard_D1_v2",
                "Standard_DS1",
                "Standard_D1",
                "Standard_A1_v2",
                "Standard_A2_v2",
                "Standard_A0",
                "Standard_A1",
                "Standard_A2",
                "Standard_F1s",
                "Standard_F2s",
                "Standard_F1",
                "Standard_F2",
                "Basic_A0",
                "Basic_A1",
                "Basic_A2",
                "Basic_A3"
              ]
            },
            "osPlatform": "Linux",
            "imageReference": {
              "publisher": "informatica",
              "offer": "eic-preview",
              "sku": "eicvm"
            }
          },

          {
            "name": "allowedIpRange",
            "type": "Microsoft.Common.TextBox",
            "label": "IP Address Range",
            "defaultValue": "0.0.0.0/0",
            "toolTip": "CIDR IP range that is permitted to access Informatica Domain. The default value allows access to all IPs.",
            "constraints": {
              "required": true,
              "regex": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$",
              "validationMessage": "The value should be in CIDR IP format like 10.0.0.0/24. "
            }
          },

          {
            "name": "clusterSize",
            "type": "Microsoft.Common.DropDown",
            "toolTip": "Based on the size of the data set, select the size of the cluster required. (i) Default (Standard_D4_v2, two nodes) (ii) Small (Standard_D4_v2, three nodes) (iii) Medium (Standard_D4_v2, five nodes) (iv) High (Standard_D4_v2, seven nodes) ",
            "defaultValue": "Default",
            "label": "Data Set Size",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Default",
                  "value": "default"
                },
                {
                  "label": "Small",
                  "value": "low"
                },
                {
                  "label": "Medium",
                  "value": "medium"
                },
                {
                  "label": "High",
                  "value": "high"
                }
              ]
            }
          },
          {
            "name": "importSampleContents",
            "type": "Microsoft.Common.DropDown",
            "defaultValue": "Yes",
            "toolTip": "Select Yes to import sample catalog data that you can use to get started with the product.",
            "label": "Import Sample Content",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": "true"
                },
                {
                  "label": "No",
                  "value": "false"
                }
              ]
            }
          }
        ]
      },

      {
        "name": "infraConfiguration",
        "label": "Infrastructure Settings",
        "subLabel": {
          "preValidation": "Configure Database, Storage, and VNET settings",
          "postValidation": "Done"
        },
        "bladeTitle": "Infrastructure Settings",
        "elements": [

          {
            "name": "sqlServerUsername",
            "type": "Microsoft.Common.TextBox",
            "label": "Informatica Database Instance Username",
            "defaultValue": "dbuser",
            "toolTip": "Database username to be created for the Informatica domain and services.",
            "constraints": {
              "required": true,
              "regex": "(?!^(p|P)(u|U)(b|B)(l|L)(i|I)(c|C)$)(?!^(d|D)(b|B)(o|O)$)(?!^(s|S)(y|Y)(s|S)$)(?!^(g|G)(u|U)(e|E)(s|S)(t|T)$)(^[a-zA-Z][a-zA-Z0-9_-]{2,127}.*$)",
              "validationMessage": "Username must begin with an alphabet, only alphanumeric characters, hyphen and underscore are allowed, and the value must be 3-128 characters in length. Usernames sa, public, dbo, sys, and guest are not allowed."
            }
          },
          {
            "name": "sqlServerPassword",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "Informatica Database Instance Password"
            },
            "constraints": {
              "required": true,
              "regex": "^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d)(?=.*[^\\s\\w])(?!.*[\"$]).{8,123}$",
              "validationMessage": "Password must be at least 8 characters in length. Should contain at least one special character, number, upper-case and lower-case character. Double quote(\") and dollar($) are not allowed."
            },
            "options": {
              "hideConfirmation": true
            }
          },

          {
            "name": "storageAccount",
            "type": "Microsoft.Storage.StorageAccountSelector",
            "label": "Storage account",
            "toolTip": "Storage account for cluster and virtual machine.",
            "defaultValue": {
              "type": "Standard_LRS"
            },
            "constraints": {
              "excludedTypes": ["Premium_LRS"]
            }
          },
          {
            "name": "infavnet",
            "type": "Microsoft.Network.VirtualNetworkCombo",
            "label": {
              "virtualNetwork": "Virtual network",
              "subnets": "Subnets"
            },
            "toolTip": {
              "virtualNetwork": "Select the existing virtual network based on the subscription and location or create a new virtual network.",
              "subnets": "Select the subnets that must include all resources."
            },
            "defaultValue": {
              "name": "InfaVNET",
              "addressPrefixSize": "/16"
            },
            "constraints": {
              "minAddressPrefixSize": "/24"
            },
            "subnets": {
              "subnet1": {
                "label": "Subnet",
                "defaultValue": {
                  "name": "InfaSubnet",
                  "addressPrefixSize": "/24"
                },
                "constraints": {
                  "minAddressPrefixSize": "/24",
                  "minAddressCount": "15",
                  "requireContiguousAddresses": true
                }
              }
            }
          }
        ]
      }

    ],
    "outputs": {


      "resourcesDeployLocation": "[location()]",
      "informaticaAdministratorUsername": "[steps('infaDomainConfiguration').infaDomainUser]",
      "informaticaAdministratorPassword": "[steps('infaDomainConfiguration').infaDomainPassword]",
      "informaticaLicenseFullPath": "[steps('infaDomainConfiguration').infaDomainLicense]",
      "informaticaDomainInstanceType": "[steps('infaDomainConfiguration').informaticaServerInstanceSize]",
      "loadType": "[steps('infaDomainConfiguration').clusterSize]",
      "importSampleData": "[steps('infaDomainConfiguration').importSampleContents]",

      "sqlServerUsername": "[steps('infraConfiguration').sqlServerUsername]",
      "sqlServerPassword": "[steps('infraConfiguration').sqlServerPassword]",
      "storageExistingOrNew": "[steps('infraConfiguration').storageAccount.newOrExisting]",
      "existingStorageRG": "[steps('infraConfiguration').storageAccount.resourceGroup]",
      "azureStorageName": "[steps('infraConfiguration').storageAccount.name]",
      "vnetExistingOrNew": "[steps('infraConfiguration').infavnet.newOrExisting]",
      "existingVnetRG": "[steps('infraConfiguration').infavnet.resourceGroup]",
      "informaticaVirtualNetworkName": "[steps('infraConfiguration').infavnet.name]",
      "vnetAddressPrefix": "[steps('infraConfiguration').infavnet.addressPrefix]",
      "informaticaSubnetName": "[steps('infraConfiguration').infavnet.subnets.subnet1.name]",
      "subnetPrefix": "[steps('infraConfiguration').infavnet.subnets.subnet1.addressPrefix]"

    }
  }
}
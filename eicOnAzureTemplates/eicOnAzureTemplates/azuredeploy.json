{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "hdinsightClusterName": {
      "type": "String",
      "metadata": {
        "description": "The name of the HDInsight cluster to create."
      }
    },
    "hdinsightClusterLoginUsername": {
      "defaultValue": "admin",
      "type": "String",
      "metadata": {
        "description": "These credentials can be used to submit jobs to the cluster and to log into cluster dashboards."
      }
    },
    "hdinsightClusterLoginPassword": {
      "type": "SecureString",
      "metadata": {
        "description": "The password must be at least 10 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
      }
    },
    "resourcesDeployLocation": {
      "defaultValue": "Southeast Asia",
      "allowedValues": [
        "West US",
        "Southeast Asia"
      ],
      "type": "String",
      "metadata": {
        "description": "The location where all azure resources will be deployed."
      }
    },
    "informaticaDomainHostName": {
      "defaultValue": "infadomainnode",
      "type": "String",
      "metadata": {
        "description": "The name of infa domain node VM."
      }
    },
    "informaticaDomainInstanceType": {
      "defaultValue": "Standard_D4_v2",
      "allowedValues": [
        "Standard_D3_v2",
        "Standard_D4_v2",
        "Standard_D5_v2"
      ],
      "type": "String",
      "metadata": {
        "description": "The SKU for infa domain node VM."
      }
    },

    "informaticaDomainHostSshUsername": {
      "defaultValue": "sshuser",
      "type": "String",
      "metadata": {
        "description": "The ssh user for infa domain node."
      }
    },
    "informaticaDomainHostSshPassword": {
      "type": "SecureString",
      "metadata": {
        "description": "The ssh user password for infa domain node."
      }
    },
    "informaticaVirtualNetworkName": {
      "defaultValue": "infavnet",
      "type": "String",
      "metadata": {
        "description": "The virtual network name."
      }
    },
    "informaticaSubnetName": {
      "type": "string",
      "defaultValue": "infasubnet",
      "metadata": {
        "description": "The subnet name."
      }
    },
    "informaticaNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "infansg",
      "metadata": {
        "description": "The network security group name."
      }
    },
    "informaticaLicenseFullPath": {
      "type": "string",
      "defaultValue": "/opt/Informatica/10.2.0/Both_EIC_BDM_Enabled_2324241_8822.key",
      "metadata": {
        "description": "The infa domain node VM vhd generation location."
      }
    },
    "informaticaAdministratorUsername": {
      "type": "string",
      "defaultValue": "Administrator",
      "metadata": {
        "description": "The Informatica Administrator login user."
      }
    },
    "informaticaAdministratorPassword": {
      "type": "string",
      "defaultValue": "Administrator",
      "metadata": {
        "description": "The Informatica Administrator login password."
      }
    },
    "loadType": {
      "type": "string",
      "allowedValues": [
        "low",
        "medium",
        "high",
        "default"
      ],
      "defaultValue": "default",
      "metadata": {
        "description": "The Catalog Service data load type."
      }
    },
    "importSampleData": {
      "type": "string",
      "allowedValues": [
        "true",
        "false"
      ],
      "defaultValue": "true",
      "metadata": {
        "description": "Import Sample Contents."
      }
    },
    "sqlServerName": {
      "type": "string",
      "defaultValue": "infasqldb",
      "metadata": {
        "description": "Sql Server Name."
      }
    },
    "sqlServerUsername": {
      "type": "string",
      "defaultValue": "dbuser",
      "metadata": {
        "description": "Sql Server Login Username."
      }
    },
    "sqlServerPassword": {
      "type": "SecureString",
      "metadata": {
        "description": "Sql Server Login Password."
      }
    }
  },
  "variables": {
    "baseUrl": "https://raw.githubusercontent.com/robsharm/gitrepo/master/eicOnAzureTemplates/eicOnAzureTemplates/",
    "hdinsightClusterDeployTemplateUri": "[concat(variables('baseUrl'), 'clusterdeploy.json')]",
    "azureStorageName": "[concat(parameters('hdinsightClusterName'),'store')]",
    "azureStorageDeployTemplateUri": "[concat(variables('baseUrl'), 'storagedeploy.json')]",
    "azureStorageLocation": "[parameters('resourcesDeployLocation')]",
    "infaDomainNodeDeployTemplateUri": "[concat(variables('baseUrl'), 'infadomainnodedeploy.json')]",
    "infaDomainNodeLocation": "[parameters('resourcesDeployLocation')]",
    "virtualNetworkDeployTemplateUri": "[concat(variables('baseUrl'), 'virtualnetworkdeploy.json')]",
    "vnetLocation": "[parameters('resourcesDeployLocation')]",
    "vnetId": "[resourceId('Microsoft.Network/virtualNetworks', parameters('informaticaVirtualNetworkName'))]",
    "subnetId": "[concat(variables('vnetId'), '/subnets/', parameters('informaticaSubnetName'))]",
    "nsgDeployTemplateUri": "[concat(variables('baseUrl'), 'networksecuritygroupdeploy.json')]",
    "nsgLocation": "[parameters('resourcesDeployLocation')]",
    "sqlDbDeployUri": "[concat(variables('baseUrl'), 'sqldatabasedeploy.json')]",
    "mrsDbName": "mrs",
    "disDbName": "dis",
    "cmsDbName": "cms",
    "domainDbName": "domain",
    "informaticaVirtualNetworkAddressPrefix": "10.0.0.0/16",
    "informaticaSubnetAddressPrefix": "10.0.0.0/24",
    "azureStorageType": "Standard_LRS",
    "hdinsightClusterHostSshUsername": "[parameters('informaticaDomainHostSshUsername')]",
    "hdinsightClusterHostSshPassword": "[parameters('informaticaDomainHostSshPassword')]",
    "hdinsightClusterType": "hadoop",
    "clusterWorkerNodeCounts": {
      "low": "1",
      "default": "2",
      "medium": "3",
      "high": "6"
    },
    "hdinsightClusterWorkerNodeCount": "[variables('clusterWorkerNodeCounts')[parameters('loadType')]]",
    "hdinsightClusterHeadNodeCount": "2",
    "hdinsightClusterHeadNodeType": "Standard_D3_v2",
    "hdinsightClusterWorkerNodeType": "Standard_D4_v2",
    "hdinsightClusterZookeeperNodeCount": "3",
    "hdinsightClusterZookeeperNodeType": "Small",
    "hdinsightClusterVersion": "3.5",
    "informaticaDomainHostImageUri": "https://eicvmforvhdstorage.blob.core.windows.net/system/Microsoft.Compute/Images/vhd/eicvmforvhd-osDisk.527e641b-d466-47c5-86c1-4d92335ff6a4.vhd",
    "informaticaDomainHostVhdLocation": "https://eicvmforvhdstorage.blob.core.windows.net/linuxvhd/"
  },

  "resources": [

    //Storage setup
    
    {
      "name": "storageSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('azureStorageDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "azureStorageLocation": {
            "value": "[variables('azureStorageLocation')]"
          },
          "azureStorageName": {
            "value": "[variables('azureStorageName')]"
          },
          "azureStorageType": {
            "value": "[variables('azureStorageType')]"
          }
        }
      }
    },


    //Virtual network setup

    {
      "name": "vnetSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('virtualNetworkDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vnetLocation": {
            "value": "[variables('vnetLocation')]"
          },
          "informaticaVirtualNetworkName": {
            "value": "[parameters('informaticaVirtualNetworkName')]"
          },
          "informaticaVirtualNetworkAddressPrefix": {
            "value": "[variables('informaticaVirtualNetworkAddressPrefix')]"
          },
          "informaticaSubnetName": {
            "value": "[parameters('informaticaSubnetName')]"
          },
          "informaticaSubnetAddressPrefix": {
            "value": "[variables('informaticaSubnetAddressPrefix')]"
          }
        }
      }
    },

    // Network security group setup
    {
      "name": "nsgSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('nsgDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "networkSecurityGroupLocation": {
            "value": "[variables('nsgLocation')]"
          },
          "informaticaNetworkSecurityGroupName": {
            "value": "[parameters('informaticaNetworkSecurityGroupName')]"
          }
        }
      }
    },
    

    //HDInsight cluster setup

    {
      "name": "clusterSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/storageSetup",
        "Microsoft.Resources/deployments/vnetSetup"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('hdinsightClusterDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },

        "parameters": {
          "hdinsightClusterVersion": {
            "value": "[variables('hdinsightClusterVersion')]"
          },
          "hdinsightClusterName": {
            "value": "[parameters('hdinsightClusterName')]"
          },
          "hdinsightClusterLoginUsername": {
            "value": "[parameters('hdinsightClusterLoginUsername')]"
          },
          "hdinsightClusterLoginPassword": {
            "value": "[parameters('hdinsightClusterLoginPassword')]"
          },
          "hdinsightClusterHostSshUsername": {
            "value": "[variables('hdinsightClusterHostSshUsername')]"
          },
          "hdinsightClusterHostSshPassword": {
            "value": "[variables('hdinsightClusterHostSshPassword')]"
          },
          "clusterDeployLocation": {
            "value": "[parameters('resourcesDeployLocation')]"
          },
          "hdinsightClusterType": {
            "value": "[variables('hdinsightClusterType')]"
          },
          "hdinsightClusterHeadNodeCount": {
            "value": "[variables('hdinsightClusterHeadNodeCount')]"
          },
          "hdinsightClusterHeadNodeType": {
            "value": "[variables('hdinsightClusterHeadNodeType')]"
          },
          "hdinsightClusterWorkerNodeCount": {
            "value": "[variables('hdinsightClusterWorkerNodeCount')]"
          },
          "hdinsightClusterWorkerNodeType": {
            "value": "[variables('hdinsightClusterWorkerNodeType')]"
          },
          "hdinsightClusterZookeeperNodeCount": {
            "value": "[variables('hdinsightClusterZookeeperNodeCount')]"
          },
          "hdinsightClusterZookeeperNodeType": {
            "value": "[variables('hdinsightClusterZookeeperNodeType')]"
          },
          "azureStorageName": {
            "value": "[variables('azureStorageName')]"
          },
          "vnetId": {
            "value": "[variables('vnetId')]"
          },
          "subnetId": {
            "value": "[variables('subnetId')]"
          }
        }
      }
    },
    
    //DB setup

    
    {
      "name": "dbSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('sqlDbDeployUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "sqlServerPassword": {
            "value": "[parameters('sqlServerPassword')]"
          },
          "sqlServerDeployLocation": {
            "value": "[parameters('resourcesDeployLocation')]"
          },
          "sqlDbDeployUri": {
            "value": "[variables('sqlDbDeployUri')]"
          },
          "sqlServerUsername": {
            "value": "[parameters('sqlServerUsername')]"
          },
          "sqlServerName": {
            "value": "[parameters('sqlServerName')]"
          },
          "domainDbName": {
            "value": "[variables('domainDbName')]"
          },
          "mrsDbName": {
            "value": "[variables('mrsDbName')]"
          },
          "disDbName": {
            "value": "[variables('disDbName')]"
          },
          "cmsDbName": {
            "value": "[variables('cmsDbName')]"
          }
        }
      }
    },
    
    //Infa domain node VM setup

    {
      "name": "infaDomainNodeSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/storageSetup",
          "Microsoft.Resources/deployments/vnetSetup",
          "Microsoft.Resources/deployments/clusterSetup",
          "Microsoft.Resources/deployments/nsgSetup",
       "Microsoft.Resources/deployments/dbSetup"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('infaDomainNodeDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "infaDomainNodeLocation": {
            "value": "[variables('infaDomainNodeLocation')]"
          },
          "informaticaDomainHostName": {
            "value": "[parameters('informaticaDomainHostName')]"
          },
          "informaticaDomainInstanceType": {
            "value": "[parameters('informaticaDomainInstanceType')]"
          },
          "informaticaDomainHostSshUsername": {
            "value": "[parameters('informaticaDomainHostSshUsername')]"
          },
          "informaticaDomainHostSshPassword": {
            "value": "[parameters('informaticaDomainHostSshPassword')]"
          },
          "subnetId": {
            "value": "[variables('subnetId')]"
          },
          "informaticaNetworkSecurityGroupName": {
            "value": "[parameters('informaticaNetworkSecurityGroupName')]"
          },
          "azureStorageName": {
            "value": "[variables('azureStorageName')]"
          },
          "informaticaDomainHostImageUri": {
            "value": "[variables('informaticaDomainHostImageUri')]"
          },
          "informaticaDomainHostVhdLocation": {
            "value": "[variables('informaticaDomainHostVhdLocation')]"
          },
          "informaticaLicenseFullPath": {
            "value": "[parameters('informaticaLicenseFullPath')]"
          },
          "sqlServerUsername": {
            "value": "[parameters('sqlServerUsername')]"
          },
          "sqlServerPassword": {
            "value": "[parameters('sqlServerPassword')]"
          },
          "sqlServerName": {
            "value": "[parameters('sqlServerName')]"
          },
          "mrsDbName": {
            "value": "[variables('mrsDbName')]"
          },
          "domainDbName": {
            "value": "[variables('domainDbName')]"
          },
          "disDbName": {
            "value": "[variables('disDbName')]"
          },
          "cmsDbName": {
            "value": "[variables('cmsDbName')]"
          },
          "baseUrl": {
            "value": "[variables('baseUrl')]"
          },
          "informaticaAdministratorUsername": {
            "value": "[parameters('informaticaAdministratorUsername')]"
          },
          "informaticaAdministratorPassword": {
            "value": "[parameters('informaticaAdministratorPassword')]"
          },
          "hdinsightClusterName": {
            "value": "[parameters('hdinsightClusterName')]"
          },
          "hdinsightClusterLoginUsername": {
            "value": "[parameters('hdinsightClusterLoginUsername')]"
          },
          "hdinsightClusterLoginPassword": {
            "value": "[parameters('hdinsightClusterLoginPassword')]"
          },
          "hdinsightClusterHostLoginUsername": {
            "value": "[variables('hdinsightClusterHostSshUsername')]"
          },
          "hdinsightClusterHostPassword": {
            "value": "[variables('hdinsightClusterHostSshPassword')]"
          },
          "loadType": {
            "value": "[parameters('loadType')]"
          },
          "importSampleData": {
            "value": "[parameters('importSampleData')]"
          }
        }
      }
    }


  ],
  "outputs": {}
}

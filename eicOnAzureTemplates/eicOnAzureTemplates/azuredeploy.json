{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourcesDeployLocation": {
      "defaultValue": "Southeast Asia",
      "allowedValues": [
        "West US",
        "Southeast Asia"
      ],
      "type": "String",
      "metadata": {
        "description": "The location where all azure resources will be deployed."
      }
    },
    "informaticaLicenseFullPath": {
      "type": "SecureString",
      "defaultValue": "",
      "metadata": {
        "description": "The infa domain node VM vhd generation location."
      }
    },
    "informaticaAdministratorUsername": {
      "type": "string",
      "defaultValue": "Administrator",
      "metadata": {
        "description": "The Informatica Administrator login user."
      }
    },
    "informaticaAdministratorPassword": {
      "type": "SecureString",
      "metadata": {
        "description": "The Informatica Administrator login password."
      }
    },
    "informaticaDomainInstanceType": {
      "defaultValue": "Standard_D5_v2",
      "type": "String",
      "metadata": {
        "description": "The SKU for infa domain node VM."
      }
    },
    "sqlServerUsername": {
      "type": "string",
      "defaultValue": "dbuser",
      "metadata": {
        "description": "Sql Server Login Username."
      }
    },
    "sqlServerPassword": {
      "type": "SecureString",
      "metadata": {
        "description": "Sql Server Login Password."
      }
    },
    "informaticaVirtualNetworkName": {
      "defaultValue": "infavnet",
      "type": "String",
      "metadata": {
        "description": "The virtual network name."
      }
    },
    "informaticaSubnetName": {
      "type": "string",
      "defaultValue": "infasubnet",
      "metadata": {
        "description": "The subnet name."
      }
    },

    "loadType": {
      "type": "string",
      "allowedValues": [
        "low",
        "medium",
        "high",
        "default"
      ],
      "defaultValue": "default",
      "metadata": {
        "description": "The Catalog Service data load type."
      }
    },
    "importSampleData": {
      "type": "string",
      "allowedValues": [
        "true",
        "false"
      ],
      "defaultValue": "true",
      "metadata": {
        "description": "Import Sample Contents."
      }
    },
    "vnetExistingOrNew": {
      "type": "string",
      "allowedValues": [
        "existing",
        "new"
      ],
      "defaultValue": "new",
      "metadata": {
        "description": "VNET new or existing"
      }
    },
    "existingVnetRG": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing VNET resource group name"
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "VNET address prefix"
      }
    },
    "subnetPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Subnet address prefix"
      }
    },
    "storageExistingOrNew": {
      "type": "string",
      "allowedValues": [
        "existing",
        "new"
      ],
      "defaultValue": "new",
      "metadata": {
        "description": "Storage new or existing"
      }
    },
    "existingStorageRG": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing storage resource group name"
      }
    },
    "allowedIpRange": {
      "type": "string",
      "defaultValue": "*",
      "metadata": {
        "description": "CIDR IP range that is permitted to access Informatica domain. The default value allows access to all IPs."
      }
    },
    "azureStorageName": {
      "type": "string",
      "defaultValue": "infastorage",
      "metadata": {
        "description": "Azure storage."
      }
    },
    "baseUrl": {
      "type": "string",
      "metadata": {
        "description": "Base URL for Marketplace",
        "artifactsBaseUrl": "https://raw.githubusercontent.com/robsharm/gitrepo/master/eicOnAzureTemplates/eicOnAzureTemplates"
      },
      "defaultValue": "https://raw.githubusercontent.com/robsharm/gitrepo/master/eicOnAzureTemplates/eicOnAzureTemplates"
    },
    "informaticaTags": {
      "type": "object",
      "defaultValue": {
        "provider": "AACF690D-C725-4C78-9B1E-E586595B369F"
      }
    }
  },
  "variables": {
    "baseUri": "[concat(parameters('baseUrl'), '/')]",
    "hdinsightClusterDeployTemplateUri": "[concat(variables('baseUri'), 'clusterdeploy.json')]",
    "hdinsightClusterName": "[toLower(concat('cluster', uniqueString(resourceGroup().id)))]",
    "informaticaDomainHostName": "[toLower(concat('infadomainnode', uniqueString(resourceGroup().id)))]",
    "informaticaNetworkSecurityGroupName": "[toLower(concat('infansg', uniqueString(resourceGroup().id)))]",
    "sqlServerName": "[toLower(concat('sqlserver', uniqueString(resourceGroup().id)))]",
    "mrsDbName": "mrs",
    "disDbName": "dis",
    "cmsDbName": "cms",
    "domainDbName": "domain",
    "azureStorageDeployTemplateUri": "[concat(variables('baseuri'), 'storagedeploy',parameters('storageExistingOrNew'),'.json')]",
    "azureStorageLocation": "[parameters('resourcesDeployLocation')]",
    "infaDomainNodeDeployTemplateUri": "[concat(variables('baseUri'), 'infadomainnodedeploy.json')]",
    "infaDomainNodeLocation": "[parameters('resourcesDeployLocation')]",
    "virtualNetworkDeployTemplateUri": "[concat(variables('baseuri'), 'virtualnetworkdeploy', parameters('vnetExistingOrNew'),'.json')]",
    "vnetLocation": "[parameters('resourcesDeployLocation')]",
    "vnetIDs": {
      "existing": "[resourceId(parameters('existingVnetRG'), 'Microsoft.Network/virtualNetworks', parameters('informaticaVirtualNetworkName'))]",
      "new": "[resourceId('Microsoft.Network/virtualNetworks', parameters('informaticaVirtualNetworkName'))]"
    },
    "vnetId": "[variables('vnetIDs')[parameters('vnetExistingOrNew')]]",
    "subnetId": "[concat(variables('vnetID'), '/subnets/', parameters('informaticaSubnetName'))]",
    "nsgDeployTemplateUri": "[concat(variables('baseUri'), 'networksecuritygroupdeploy.json')]",
    "nsgLocation": "[parameters('resourcesDeployLocation')]",
    "sqlDbDeployUri": "[concat(variables('baseUri'), 'sqldatabasedeploy.json')]",
    "informaticaVirtualNetworkAddressPrefix": "[parameters('vnetAddressPrefix')]",
    "informaticaSubnetAddressPrefix": "[parameters('subnetPrefix')]",
    "azureStorageType": "Standard_LRS",
    "informaticaDomainHostSshUsername": "sshuser",
    "informaticaDomainHostSshPassword": "[parameters('informaticaAdministratorPassword')]",
    "hdinsightClusterHostSshUsername": "sshuser",
    "hdinsightClusterHostSshPassword": "[parameters('informaticaAdministratorPassword')]",
    "hdinsightClusterType": "hadoop",
    "clusterWorkerNodeCounts": {
      "low": "3",
      "default": "2",
      "medium": "5",
      "high": "7"
    },
    "hdinsightClusterWorkerNodeCount": "[variables('clusterWorkerNodeCounts')[parameters('loadType')]]",
    "hdinsightClusterHeadNodeCount": "2",
    "hdinsightClusterHeadNodeType": "Standard_D3_v2",
    "hdinsightClusterWorkerNodeType": "Standard_D4_v2",
    "hdinsightClusterZookeeperNodeCount": "3",
    "hdinsightClusterZookeeperNodeType": "Small",
    "hdinsightClusterVersion": "3.5",
    "informaticaDomainHostImageUri": "https://eicvmforvhdstorage.blob.core.windows.net/system/Microsoft.Compute/Images/vhd/infadomainnode1-osDisk.a1fd3401-caa4-4a49-9805-f61ebcadb830.vhd",
    "informaticaDomainHostVhdLocation": "https://eicvmforvhdstorage.blob.core.windows.net/linuxvhd11/",
    "hdinsightClusterLoginUsername": "admin",
    "hdinsightClusterLoginPassword": "[parameters('informaticaAdministratorPassword')]",
    "resourcesDeployLocation": "[parameters('resourcesDeployLocation')]",
    "osVersion": "eicvm",
    "imagePublisher": "informatica",
    "imageOffer": "eic-preview"
  },

  "resources": [

  
    {
      "name": "storageSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('azureStorageDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "azureStorageLocation": {
            "value": "[variables('azureStorageLocation')]"
          },
          "azureStorageName": {
            "value": "[parameters('azureStorageName')]"
          },
          "azureStorageType": {
            "value": "[variables('azureStorageType')]"
          },
          "existingStorageRG": {
            "value": "[parameters('existingStorageRG')]"
          },
          "informaticaTags": {
            "value": "[parameters('informaticaTags')]"
          }
        }
      }
    },

    
    

    {
      "name": "vnetSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('virtualNetworkDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vnetLocation": {
            "value": "[variables('vnetLocation')]"
          },
          "informaticaVirtualNetworkName": {
            "value": "[parameters('informaticaVirtualNetworkName')]"
          },
          "informaticaVirtualNetworkAddressPrefix": {
            "value": "[variables('informaticaVirtualNetworkAddressPrefix')]"
          },
          "informaticaSubnetName": {
            "value": "[parameters('informaticaSubnetName')]"
          },
          "informaticaSubnetAddressPrefix": {
            "value": "[variables('informaticaSubnetAddressPrefix')]"
          },
          "existingVnetRG": {
            "value": "[parameters('existingVnetRG')]"
          },
          "informaticaTags": {
            "value": "[parameters('informaticaTags')]"
          }
        }
      }
    },

    
    {
      "name": "nsgSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('nsgDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "networkSecurityGroupLocation": {
            "value": "[variables('nsgLocation')]"
          },
          "informaticaNetworkSecurityGroupName": {
            "value": "[variables('informaticaNetworkSecurityGroupName')]"
          },
          "allowedIpRange": {
            "value": "[parameters('allowedIpRange')]"
          },
          "informaticaTags": {
            "value": "[parameters('informaticaTags')]"
          }
        }
      }
    },
    

    

    {
      "name": "clusterSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/storageSetup",
        "Microsoft.Resources/deployments/vnetSetup"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('hdinsightClusterDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },

        "parameters": {
          "hdinsightClusterVersion": {
            "value": "[variables('hdinsightClusterVersion')]"
          },
          "hdinsightClusterName": {
            "value": "[variables('hdinsightClusterName')]"
          },
          "hdinsightClusterLoginUsername": {
            "value": "[variables('hdinsightClusterLoginUsername')]"
          },
          "hdinsightClusterLoginPassword": {
            "value": "[variables('hdinsightClusterLoginPassword')]"
          },
          "hdinsightClusterHostSshUsername": {
            "value": "[variables('hdinsightClusterHostSshUsername')]"
          },
          "hdinsightClusterHostSshPassword": {
            "value": "[variables('hdinsightClusterHostSshPassword')]"
          },
          "clusterDeployLocation": {
            "value": "[parameters('resourcesDeployLocation')]"
          },
          "hdinsightClusterType": {
            "value": "[variables('hdinsightClusterType')]"
          },
          "hdinsightClusterHeadNodeCount": {
            "value": "[variables('hdinsightClusterHeadNodeCount')]"
          },
          "hdinsightClusterHeadNodeType": {
            "value": "[variables('hdinsightClusterHeadNodeType')]"
          },
          "hdinsightClusterWorkerNodeCount": {
            "value": "[variables('hdinsightClusterWorkerNodeCount')]"
          },
          "hdinsightClusterWorkerNodeType": {
            "value": "[variables('hdinsightClusterWorkerNodeType')]"
          },
          "hdinsightClusterZookeeperNodeCount": {
            "value": "[variables('hdinsightClusterZookeeperNodeCount')]"
          },
          "hdinsightClusterZookeeperNodeType": {
            "value": "[variables('hdinsightClusterZookeeperNodeType')]"
          },
          "azureStorageName": {
            "value": "[parameters('azureStorageName')]"
          },
          "vnetId": {
            "value": "[variables('vnetId')]"
          },
          "subnetId": {
            "value": "[variables('subnetId')]"
          },
          "informaticaTags": {
            "value": "[parameters('informaticaTags')]"
          }
        }
      }
    },
    
    

    
    {
      "name": "dbSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('sqlDbDeployUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "sqlServerPassword": {
            "value": "[parameters('sqlServerPassword')]"
          },
          "sqlServerDeployLocation": {
            "value": "[parameters('resourcesDeployLocation')]"
          },
          "sqlDbDeployUri": {
            "value": "[variables('sqlDbDeployUri')]"
          },
          "sqlServerUsername": {
            "value": "[parameters('sqlServerUsername')]"
          },
          "sqlServerName": {
            "value": "[variables('sqlServerName')]"
          },
          "domainDbName": {
            "value": "[variables('domainDbName')]"
          },
          "mrsDbName": {
            "value": "[variables('mrsDbName')]"
          },
          "disDbName": {
            "value": "[variables('disDbName')]"
          },
          "cmsDbName": {
            "value": "[variables('cmsDbName')]"
          },
          "informaticaTags": {
            "value": "[parameters('informaticaTags')]"
          }
        }
      }
    },
    
   

    {
      "name": "infaDomainNodeSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/storageSetup",
       "Microsoft.Resources/deployments/vnetSetup",
      "Microsoft.Resources/deployments/clusterSetup",
       "Microsoft.Resources/deployments/nsgSetup",
      "Microsoft.Resources/deployments/dbSetup"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('infaDomainNodeDeployTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "infaDomainNodeLocation": {
            "value": "[variables('infaDomainNodeLocation')]"
          },
          "informaticaDomainHostName": {
            "value": "[variables('informaticaDomainHostName')]"
          },
          "informaticaDomainInstanceType": {
            "value": "[parameters('informaticaDomainInstanceType')]"
          },
          "informaticaDomainHostSshUsername": {
            "value": "[variables('informaticaDomainHostSshUsername')]"
          },
          "informaticaDomainHostSshPassword": {
            "value": "[variables('informaticaDomainHostSshPassword')]"
          },
          "subnetId": {
            "value": "[variables('subnetId')]"
          },
          "informaticaNetworkSecurityGroupName": {
            "value": "[variables('informaticaNetworkSecurityGroupName')]"
          },
          "azureStorageName": {
            "value": "[parameters('azureStorageName')]"
          },
          "informaticaDomainHostImageUri": {
            "value": "[variables('informaticaDomainHostImageUri')]"
          },
          "informaticaDomainHostVhdLocation": {
            "value": "[variables('informaticaDomainHostVhdLocation')]"
          },
          "informaticaLicenseFullPath": {
            "value": "[parameters('informaticaLicenseFullPath')]"
          },
          "sqlServerUsername": {
            "value": "[parameters('sqlServerUsername')]"
          },
          "sqlServerPassword": {
            "value": "[parameters('sqlServerPassword')]"
          },
          "sqlServerName": {
            "value": "[variables('sqlServerName')]"
          },
          "mrsDbName": {
            "value": "[variables('mrsDbName')]"
          },
          "domainDbName": {
            "value": "[variables('domainDbName')]"
          },
          "disDbName": {
            "value": "[variables('disDbName')]"
          },
          "cmsDbName": {
            "value": "[variables('cmsDbName')]"
          },
          "baseUrl": {
            "value": "[variables('baseUri')]"
          },
          "informaticaAdministratorUsername": {
            "value": "[parameters('informaticaAdministratorUsername')]"
          },
          "informaticaAdministratorPassword": {
            "value": "[parameters('informaticaAdministratorPassword')]"
          },
          "hdinsightClusterName": {
            "value": "[variables('hdinsightClusterName')]"
          },
          "hdinsightClusterLoginUsername": {
            "value": "[variables('hdinsightClusterLoginUsername')]"
          },
          "hdinsightClusterLoginPassword": {
            "value": "[variables('hdinsightClusterLoginPassword')]"
          },
          "hdinsightClusterHostLoginUsername": {
            "value": "[variables('hdinsightClusterHostSshUsername')]"
          },
          "hdinsightClusterHostPassword": {
            "value": "[variables('hdinsightClusterHostSshPassword')]"
          },
          "loadType": {
            "value": "[parameters('loadType')]"
          },
          "importSampleData": {
            "value": "[parameters('importSampleData')]"
          },
          "osVersion": {
            "value": "[variables('osVersion')]"
          },
          "imagePublisher": {
            "value": "[variables('imagePublisher')]"
          },
          "imageOffer": {
            "value": "[variables('imageOffer')]"
          },
          "informaticaTags": {
            "value": "[parameters('informaticaTags')]"
          }
        }
      }
    }


  ],
  "outputs": {}
}
